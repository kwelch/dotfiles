#!/usr/bin/env bash

NODE_SHIM_LOCATIONS=(/usr/local/bin "$HOME/.local/bin")

install_node_modules() {
  create_npx_shim || true
  return 0
}

check_node_modules() {
  if command -v npx >/dev/null 2>&1; then
    return 0
  fi
  local dir
  for dir in "${NODE_SHIM_LOCATIONS[@]}"; do
    if [ -x "$dir/npx" ]; then
      return 0
    fi
  done
  return 1
}

runtime_node_modules() {
  mkdir -p "$HOME/.local/bin"
  case ":$PATH:" in
    *":$HOME/.local/bin:") ;;
    *) PATH="$PATH:$HOME/.local/bin" ;;
  esac
  case ":$PATH:" in
    *":./node_modules/.bin:") ;;
    *) PATH="$PATH:./node_modules/.bin" ;;
  esac
  export PATH
}

create_npx_shim() {
  local target_dir=""
  for dir in "${NODE_SHIM_LOCATIONS[@]}"; do
    if mkdir -p "$dir" 2>/dev/null && [ -w "$dir" ]; then
      target_dir="$dir"
      break
    fi
  done

  if [ -z "$target_dir" ]; then
    printf 'Warning: unable to create npx shim (no writable dir)\n' >&2
    return 1
  fi

  local shim="$target_dir/npx"
  cat > "$shim" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
SHIM_BIN="$0"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  # shellcheck source=/dev/null
  . "$NVM_DIR/nvm.sh"
  nvm use --silent >/dev/null 2>&1 || true
fi
resolved=$(command -v npx 2>/dev/null || true)
if [ -n "$resolved" ] && [ "$resolved" != "$SHIM_BIN" ]; then
  exec "$resolved" "$@"
fi
current=$(nvm current 2>/dev/null || true)
if [ -n "$current" ] && [ "$current" != "system" ]; then
  candidate="$NVM_DIR/versions/node/$current/bin/npx"
  if [ -x "$candidate" ]; then
    exec "$candidate" "$@"
  fi
fi
echo "npx shim: unable to locate npx binary" >&2
exit 127
EOF
  chmod +x "$shim"
  printf 'Created npx shim at %s\n' "$shim"
}
